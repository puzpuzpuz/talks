---
marp: true
theme: default
---

<style>
section.lead h1 {
  padding-top: 69px;
}

section.lead h1, section.lead h2 {
  padding-left: 30px;
}

section {
  font-size: 30px;
}

h1 {
  font-size: 42px;
  color: #5c5c5c;
}

pre {
  line-height: 1.4;
}

img[alt~="center"] {
  display: block;
  margin: 0 auto;
}

table td {
  width: 150px;
}
</style>

<!-- _class: lead -->

# –ò—Å—Ç–æ—Ä–∏—è –æ–¥–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏<br/>–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏<br/>Node.js –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

## –ê–Ω–¥—Ä–µ–π –ü–µ—á–∫—É—Ä–æ–≤

![bg](./images/hazelcast-bg.jpg)

---

<!-- paginate: true -->

# –û –¥–æ–∫–ª–∞–¥—á–∏–∫–µ

* –ü–∏—à—É –Ω–∞ Java (10+ –ª–µ—Ç), Node.js (5+ –ª–µ—Ç)
* –ò–Ω—Ç–µ—Ä–µ—Å—ã: –≤–µ–±, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
* –ú–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ —Ç—É—Ç:

  - https://twitter.com/AndreyPechkurov
  - https://github.com/puzpuzpuz
  - https://medium.com/@apechkurov

---

# –û –¥–æ–∫–ª–∞–¥–µ

* –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã:
  - –ü–æ–¥—Ö–æ–¥ –∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ Node.js –±–∏–±–ª–∏–æ—Ç–µ–∫
  - –ò—Å—Ç–æ—Ä–∏—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –Ω–∞—à–∏—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
  - –ù–µ–º–Ω–æ–≥–æ –≤—ã–≤–æ–¥–æ–≤
* –ü–æ–¥–æ–ø—ã—Ç–Ω—ã–π:
  - –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è Node.js –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Hazelcast IMDG
* –ê—É–¥–∏—Ç–æ—Ä–∏—è:
  - –í—Å–µ, –∫—Ç–æ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–µ—Ç–µ–≤—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ Node.js

---

<style scoped>
section h1 {
  position: absolute;
  top: 261px;
  left: 90px;
}
</style>

![bg](./images/hazelcast-bg-no-logo.jpg)

# –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –ø–æ–¥–æ–ø—ã—Ç–Ω—ã–º

---

![h:80](./images/imdg-logo.jpg)

* Hazelcast In-Memory Data Grid (IMDG)
* –ë–æ–ª—å—à–æ–π –Ω–∞–±–æ—Ä —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö
* –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä - `Map`, –∫–æ—Ç–æ—Ä—ã–π —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫–∞–∫ –∫—ç—à
* –ù–∞–ø–∏—Å–∞–Ω–∞ –Ω–∞ Java, —É–º–µ–µ—Ç embedded –∏ standalone —Ä–µ–∂–∏–º—ã
* –•–æ—Ä–æ—à–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
* –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ high-load –∏ low-latency –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö
* –û–±–ª–∞—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è: IoT, in-memory stream processing, payment processing, fraud detection –∏ —Ç.–¥.

---

<br/><br/>

# Hazelcast IMDG Node.js client

<style scoped>
section {
  background: #fff url(images/hazelcast-plus-node.jpg) no-repeat center 80px;
  background-size: 400px;
}
</style>

* https://github.com/hazelcast/hazelcast-nodejs-client
* Node.js 4+
* –°—Ç–µ–∫: TypeScript, promisified API (bluebird)
* –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –µ—â–µ –¥–æ–≤–æ–ª—å–Ω–æ –º–æ–ª–æ–¥–∞: –ø–µ—Ä–≤—ã–π —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–µ–ª–∏–∑ - –º–∞–π 2019

---

# –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

* "–£–º–Ω–∞—è" –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ (–∑–Ω–∞–µ—Ç —Ç–æ–ø–æ–ª–æ–≥–∏—é –∫–ª–∞—Å—Ç–µ—Ä–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç heartbeat'—ã –∏ —Ç.–¥.)
* –û–±—â–∞–µ—Ç—Å—è —Å –Ω–æ–¥–∞–º–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ –ø–æ [–æ—Ç–∫—Ä—ã—Ç–æ–º—É –±–∏–Ω–∞—Ä–Ω–æ–º—É –ø—Ä–æ—Ç–æ–∫–æ–ª—É](https://hazelcast.org/documentation/#open-binary)<br/>–ø–æ–≤–µ—Ä—Ö TCP
* –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö
* –£–º–µ–µ—Ç near cache, retry on failure, client stats –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ
* –ö–∞–∫ —Å–ª–µ–¥—Å—Ç–≤–∏–µ - –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –±–æ–ª—å—à–∞—è –∫–æ–¥–æ–≤–∞—è –±–∞–∑–∞ (~34K —Å—Ç—Ä–æ–∫ TS –∫–æ–¥–∞, –Ω–µ —É—á–∏—Ç—ã–≤–∞—è —Ç–µ—Å—Ç—ã)

---

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```javascript
const Client = require('hazelcast-client').Client;

const client = await Client.newHazelcastClient();
const cache = await client.getMap('my-awesome-cache');

await cache.set('foo', 'bar');
const cached = await cache.get('foo');
console.log(cached); // bar
```

---

<style scoped>
section h1 {
  position: absolute;
  top: 261px;
  left: 90px;
}
</style>

![bg](./images/hazelcast-bg-no-logo.jpg)

# –ù–∞—à –ø–æ–¥—Ö–æ–¥ –∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è?

![w:1000 center](./images/i-have-no-idea.jpg)

---

# –í–æ–∑–º–æ–∂–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

* –°–µ—Ç–µ–≤–∞—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
* I/O bound –Ω–∞–≥—Ä—É–∑–∫–∞
* –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
  - –û–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Å–µ–∫—É–Ω–¥—É (throughput)
  - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ (—É—Å–ª–æ–≤–Ω–æ, latency)
* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
  - –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
  - –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

---

# –í—ã–±–æ—Ä –º–µ—Ç—Ä–∏–∫

<style scoped>
section {
  background: #fff url(images/gotta-go-fast.jpg) no-repeat 650px center;
  background-size: 550px;
}
</style>

* –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º throughput
* –ñ–µ–ª–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: ¬Ø\\_(„ÉÑ)_/¬Ø

---

<style scoped>
section h1 {
  position: absolute;
  top: 261px;
  left: 90px;
}
</style>

![bg](./images/hazelcast-bg-no-logo.jpg)

# –ù–∞—à –ø–æ–¥—Ö–æ–¥ –∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:<br/>–±–µ–Ω—á–º–∞—Ä–∫–∏, –≤–∏–¥—ã —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤<br/>–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–Ω–∞–ª–∏–∑–∞

--- 

# –ë–µ–Ω—á–º–∞—Ä–∫

```javascript
const benchmark = new Benchmark({
    nextOp: () => map.get('foo'), // —Ñ—É–Ω–∫—Ü–∏—è-—Ñ–∞–±—Ä–∏–∫–∞ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π
    totalOpsCount: REQ_COUNT,     // –æ–±—â–µ–µ —á–∏—Å–ª–æ –æ–ø–µ—Ä–∞—Ü–∏–π, 1 –º–ª–Ω
    batchSize: BATCH_SIZE         // –ª–∏–º–∏—Ç –Ω–∞ –∫–æ–ª-–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π, 100
});

await benchmark.run();
```

---

# –°—Ü–µ–Ω–∞—Ä–∏–π –±–µ–Ω—á–º–∞—Ä–∫–∞

<style scoped>
section {
  background: #fff url(images/benchmark-scenario.png) no-repeat 940px center;
  background-size: 300px;
}
</style>

* –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ-–±–µ–Ω—á–º–∞—Ä–∫  + –∫–ª–∞—Å—Ç–µ—Ä IMDG (1 –Ω–æ–¥–∞)
* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ Linux, Node.js, IMDG –∏ —Ç.–¥.
* –û–ø–µ—Ä–∞—Ü–∏–∏: `Map#get()` –∏ `Map#set()`
* –î–∞–Ω–Ω—ã–µ: —Å—Ç—Ä–æ–∫–∏ —Å ASCII-—Å–∏–º–≤–æ–ª–∞–º–∏ (3 B, 1 KB, 100 KB)
* –ó–∞–º–µ—Ä: –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—É—Å–∫–æ–≤ –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–≥–æ<br/>—Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
* –ö–∞–∂–¥—ã–π –∑–∞–ø—É—Å–∫: 1 –º–ª–Ω –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ª–∏–º–∏—Ç–æ–º 100

---

# –ì–æ—Ä—è—á–∏–π –ø—É—Ç—å –¥–ª—è –±–µ–Ω—á–º–∞—Ä–∫–∞ üî•

<style scoped>
section {
  background: #fff url(images/fire-trace.png) no-repeat 800px center;
  background-size: 450px;
}
</style>

1. –°—Ç–∞—Ä—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ `Promise`)
2. –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–∏–Ω–∞—Ä–Ω—ã–π<br/> —Ñ–æ—Ä–º–∞—Ç
3. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Å–µ—Ç—å –≤ `socket.write(...)`
4. –ß—Ç–µ–Ω–∏–µ —Ñ—Ä–µ–π–º–∞ –≤ `socket.on('data', ...)`
5. –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
6. –í—ã–∑–æ–≤ `resolve()` —É `Promise`'–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏

---

# –í–∏–¥ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ #1

* Proof of concept (PoC)
* –ü—Ä–æ—Å—Ç–µ–π—à–∏–π —Å–ø–æ—Å–æ–± –æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –Ω–∞ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ
* –í—Å–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ —Ö–æ—Ä–æ—à–∏, –Ω–æ –Ω—É–∂–µ–Ω –≤–µ—Å—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∫–æ–¥–∞ –Ω–∞ –≥–æ—Ä—è—á–µ–º –ø—É—Ç–∏

---

# –í–∏–¥ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ #2

* –ú–∏–∫—Ä–æ–±–µ–Ω—á–º–∞—Ä–∫–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –±—ã—Å—Ç—Ä–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–∏–ø–æ—Ç–µ–∑—É –∏/–∏–ª–∏ –æ–±–æ—Å–Ω–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã PoC
* *–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ*: –º–æ–≥—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –≤ –ê–Ω—Ç–∞—Ä–∫—Ç–∏–¥–µ
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ [Benchmark.js](https://benchmarkjs.com/) (+ node-microtime)

---

# –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç #1

* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫ Node.js:
`node --prof app.js`
* –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ V8 sample-based profiler
* –£—á–∏—Ç—ã–≤–∞–µ—Ç JS –∏ C++ –∫–æ–¥
* –ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ:
`node --prof-process isolate-0xnnnnnnnnnnnn-v8.log > processed.txt`

---

# –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç #2

* –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫–∞ –≤ –≤–∏–¥–µ flame graph
* –û—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è event loop'–∞ Node.js –∏ –ø–æ–º–æ–≥–∞–µ—Ç –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—Ç—å —É–∑–∫–∏–µ –º–µ—Å—Ç–∞
* –°–ø–∞—Å–∏–±–æ Brendan Gregg, Netflix, [–ø—Ä–∏–¥—É–º–∞–≤—à–µ–º—É –ø–æ–¥—Ö–æ–¥](https://www.usenix.org/conference/lisa13/technical-sessions/plenary/gregg) –≤ 2013
* –ú—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç - [0x](https://github.com/davidmarkclements/0x) (—É–º–µ–µ—Ç V8, perf, DTrace)

```bash
$ npm install -g 0x
$ 0x -o app.js
```

---

# It's flame graph demo time!

![h:500 center](./images/demo.png)

---

# –ü—Ä–∏–º–µ—Ä flame graph –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–∏—Ä–∞

![w:1200 center](./images/flame-graph-complex-example.png)

---

# –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç #3

* –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫ –ø–∞–º—è—Ç–∏ –∏–∑ Chrome DevTools (Node.js)
* –£–º–µ–µ—Ç –¥–µ–ª–∞—Ç—å heap snapshot, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∞–ª–ª–æ–∫–∞—Ü–∏–∏ –∏ –Ω–µ —Ç–æ–ª—å–∫–æ

<br/>

![w:1000 center drop-shadow](./images/chrome-devtools-example.png)

---

<style scoped>
section h1 {
  position: absolute;
  top: 261px;
  left: 90px;
}
</style>

![bg](./images/hazelcast-bg-no-logo.jpg)

# –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—à–∏—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:<br/>–≥–∏–ø–æ—Ç–µ–∑—ã, —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã, –∑–∞–º–µ—Ä—ã

---

# –í–∫–ª—é—á–∞–µ–º üöó ‚åö

* –û—Ç–ø—Ä–∞–≤–ª—è–µ–º—Å—è –≤ –≤–µ—Å–Ω—É 2019 –≥–æ–¥–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∞ v0.10

---

# –ù–∞—á–∞–ª—å–Ω—ã–µ —Ü–µ–ª–∏

* –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ —Å—Ç–∞–±–∏–ª—å–Ω—ã–º —Ä–µ–ª–∏–∑–æ–º
* –í–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ä–µ–ª–∏–∑ "–±—ã—Å—Ç—Ä—ã—Ö" –ø—Ä–∞–≤–æ–∫ (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
* –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–Ω–æ–≤ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É –∞–Ω–∞–ª–∏–∑—É –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
* *–°–ø–æ–π–ª–µ—Ä*: –æ —Ç–µ–∫—É—â–∏—Ö –ø–ª–∞–Ω–∞—Ö –º—ã –ø–æ–≥–æ–≤–æ—Ä–∏–º –ø–æ–∑–∂–µ

---

# –ë–∞–∑–æ–≤—ã–π –∑–∞–º–µ—Ä

&nbsp; | `get()`<br/>3 B | `get()`<br/>1 KB | `get()`<br/>100 KB | `set()`<br/>3 B | `set()`<br/>1 KB | `set()`<br/>100 KB
------------:| ------------:| ------------:| ------------:| ------------:| ------------:| ------------:
v0.10.0 | 90 933 | 23 591 | 105 | 76 011 | 44 324 | 1 558

###### \* –ê–±—Å–æ–ª—é—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ –≤–∞–∂–Ω—ã (–≤—Å–µ –∑–∞–º–µ—Ä—ã —Å–¥–µ–ª–∞–Ω—ã –Ω–∞ –º–æ–µ–º –Ω–æ—É—Ç–±—É–∫–µ)

---

# –ü–æ—Ä–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å

* –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ñ–∏–ª–∏—Ä—É–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–π "—Ç—è–∂–µ–ª–æ–π" –∑–∞–ø–∏—Å–∏ (`Map#set()`) –∏ –≤–∏–¥–∏–º...

---

# –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫, –ø—Ä–∏–¥–∏! (–∑–∞–ø–∏—Å—å 3 B)

![w:1200 center](./images/old-set-3B-flamegraph.png)

---

# –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫, –ø—Ä–∏–¥–∏! (–∑–∞–ø–∏—Å—å 3 B)

```
...
 [C++ entry points]:
   ticks    cpp   total   name
   2775   37.8%   21.8%  v8::internal::Builtin_ArrayBufferConstructor(...)
    991   13.5%    7.8%  __libc_write
    329    4.5%    2.6%  v8::internal::Builtin_ArrayConcat(...)
...
```

---

# –•—å—é—Å—Ç–æ–Ω, —É –Ω–∞—Å –∞–ª–ª–æ–∫–∞—Ü–∏–∏

* –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∏–Ω–∞—Ä–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏, –∫–æ–Ω–µ—á–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è [Buffer](https://nodejs.org/api/buffer.html)
* –í –Ω–∞ –≥–æ—Ä—è—á–µ–º –ø—É—Ç–∏ –º–Ω–æ–≥–æ `Buffer#alloc()/#allocUnsafe()`, –∞ —ç—Ç–æ "–¥–æ—Ä–æ–≥–∞—è" –æ–ø–µ—Ä–∞—Ü–∏—è
* –í–æ –≤—Ä–µ–º—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–ª–ª–æ–∫–∞—Ü–∏–π, –∞ –∑–∞—Ç–µ–º –±—É—Ñ–µ—Ä—ã –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –≤ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π
* –≠—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –∫–æ–¥, –Ω–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞–¥–∞–µ—Ç
* –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º PoC —Å –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ–π –ø–æ–ª—É–º–µ—Ä–æ–π

---

# PoC —Å –ø–æ–ª—É–º–µ—Ä–æ–π

<style scoped>
section::before {
  width: 1100px;
  height: 110px;
  background-color: rgba(235, 225, 52, 0.1);
  border: 1px solid #73736e;
  position: absolute;
  top: 415px;
  left: 90px;
}
</style>

```javascript
export class ObjectDataOutput implements DataOutput {

    protected buffer: Buffer;
    // ...

    constructor() {
        // –ø—Ä–æ–±—É–µ–º –∞–ª–ª–æ—Ü–∏—Ä–æ–≤–∞—Ç—å –∂–∞–¥–Ω–æ
-       this.buffer = Buffer.allocUnsafe(1);
+       this.buffer = Buffer.allocUnsafe(1024);

        // ...
```

---

# –ó–∞–º–µ—Ä –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ PoC

&nbsp; | `get()`<br/>3 B | `get()`<br/>1 KB | `get()`<br/>100 KB | `set()`<br/>3 B | `set()`<br/>1 KB | `set()`<br/>100 KB
------------:| ------------:| ------------:| ------------:| ------------:| ------------:| ------------:
v0.10.0 | 90 933 | 23 591 | 105 | 76 011 | 44 324 | 1 558
PoC | 104 854 | 24 929 | 109 | 95 165 | 52 809 | 1 581
&nbsp; | **+15%** | **+5%** | **+3%** | **+25%** | **+19%** | **+1%**

---

# –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∏—Ç–æ–≥–∏

* –ì–∏–ø–æ—Ç–µ–∑–∞ –≤–µ—Ä–Ω–∞ –∏ –ø—Ä–∞–≤–∫–∞ –∏–¥–µ—Ç –≤ –±–ª–∏–∂–∞–π—à–∏–π —Ä–µ–ª–∏–∑
* –ù—É–∂–Ω–æ –∏–∑–±–∞–≤–∏—Ç—å—Å—è –æ—Ç –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –∞–ª–ª–æ–∫–∞—Ü–∏–π –≤ –±—É–¥—É—â–∏—Ö —Ä–µ–ª–∏–∑–∞—Ö
* –¢–∞–∫ —á—Ç–æ –∂–µ —É –Ω–∞—Å —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å—é –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö?

---

# –°–Ω–æ–≤–∞ –ø–æ—Ä–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å

* –¢–µ–ø–µ—Ä—å –ø—Ä–æ—Ñ–∏–ª–∏—Ä—É–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–π "—Ç—è–∂–µ–ª–æ–≥–æ" —á—Ç–µ–Ω–∏—è (`Map#get()`) –∏ –≤–∏–¥–∏–º...

---

# –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫, –ø—Ä–∏–¥–∏! (—á—Ç–µ–Ω–∏—è 100 KB)

![w:1200 center](./images/old-get-100KB-flamegraph.png)

---

# –ê —á—Ç–æ —ç—Ç–æ —É –Ω–∞—Å —Ç–∞–º?

```javascript
private readUTF(pos?: number): string {
    const len = this.readInt(pos);
    // ...
    for (let i = 0; i < len; i++) {
        let charCode: number;
        leadingByte = this.readByte(readingIndex) & MASK_1BYTE;
        readingIndex = this.addOrUndefined(readingIndex, 1);
        const b = leadingByte & 0xFF;
        switch (b >> 4) {
            // ...
        }
        result += String.fromCharCode(charCode);
    }
    return result;
}
```

---

# –ê —á—Ç–æ —ç—Ç–æ —É –Ω–∞—Å —Ç–∞–º?

<style scoped>
section::before {
  width: 1100px;
  height: 245px;
  background-color: rgba(235, 225, 52, 0.1);
  border: 1px solid #73736e;
  position: absolute;
  top: 275px;
  left: 90px;
}
</style>

```javascript
private readUTF(pos?: number): string {
    const len = this.readInt(pos);
    // ...
    for (let i = 0; i < len; i++) {
        let charCode: number;
        leadingByte = this.readByte(readingIndex) & MASK_1BYTE;
        readingIndex = this.addOrUndefined(readingIndex, 1);
        const b = leadingByte & 0xFF;
        switch (b >> 4) {
            // ...
        }
        result += String.fromCharCode(charCode);
    }
    return result;
}
```

---

# –ê —á—Ç–æ —ç—Ç–æ —É –Ω–∞—Å —Ç–∞–º?

<style scoped>
section::before {
  width: 1100px;
  height: 30px;
  background-color: rgba(235, 225, 52, 0.1);
  border: 1px solid #73736e;
  position: absolute;
  top: 524px;
  left: 90px;
}
</style>

```javascript
private readUTF(pos?: number): string {
    const len = this.readInt(pos);
    // ...
    for (let i = 0; i < len; i++) {
        let charCode: number;
        leadingByte = this.readByte(readingIndex) & MASK_1BYTE;
        readingIndex = this.addOrUndefined(readingIndex, 1);
        const b = leadingByte & 0xFF;
        switch (b >> 4) {
            // ...
        }
        result += String.fromCharCode(charCode);
    }
    return result;
}
```

---

# –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è?

* –ò—Ç–∞–∫, —É –Ω–∞—Å –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è (–¥–µ)—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è UTF-8 —Å—Ç—Ä–æ–∫
* –ü–æ—Ö–æ–∂–µ –Ω–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é (–ø—Ä–∏–≤–µ—Ç, Java-–∫–ª–∏–µ–Ω—Ç)
* –ü–æ—á–µ–º—É –±—ã –Ω–µ —Å—Ä–∞–≤–Ω–∏—Ç—å —Å–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º API?

```javascript
// —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
buf.write(inStr, start, end, 'utf8');
// –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
const outStr = buf.toString('utf8', start, end);
```

* –ü–∏—à–µ–º –º–∏–∫—Ä–æ–±–µ–Ω—á–º–∞—Ä–∫ –∏ –¥–µ–ª–∞–µ–º –∑–∞–º–µ—Ä

---

# –ú–∏–∫—Ä–æ–±–µ–Ω—á–º–∞—Ä–∫

&nbsp; | 100 B ASCII | 100 KB ASCII | 100 B<br/>UTF | 100 KB UTF
------------:| ------------:| ------------:| ------------:| ------------:
custom | 1 515 803 | 616 | 1 093 390 | 613
standard | 11 297 821 | 68 721 | 1 311 610 | 794
&nbsp; | **+645%** | **+11 056%** | **+20%** | **+29%**

###### \* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ ops/sec

---

# –ù—É–∂–Ω–æ –∏–¥—Ç–∏ –≥–ª—É–±–∂–µ

<style scoped>
section {
  background: #fff url(images/deep-dive.png) no-repeat 800px center;
  background-size: 350px;
}
</style>

* [Buffer#toString()](https://github.com/nodejs/node/blob/v10.15.3/lib/buffer.js#L667)
* [node:buffer.js#stringSlice()](https://github.com/nodejs/node/blob/v10.15.3/lib/buffer.js#L594)
* [node:node_buffer.cc#StringSlice()](https://github.com/nodejs/node/blob/v10.15.3/src/node_buffer.cc#L452)
* [node:StringBytes#Encode()](https://github.com/nodejs/node/blob/v10.15.3/src/string_bytes.cc#L665)
* [v8:String#NewFromUtf8()](https://github.com/v8/v8/blob/lkgr/6.8/src/api.cc#L6622)
* [v8:Factory#NewStringFromUtf8()](https://github.com/v8/v8/blob/lkgr/6.8/src/heap/factory.cc#L609)
* [v8:Factory#NewStringFromOneByte()](https://github.com/v8/v8/blob/lkgr/6.8/src/heap/factory.cc#L583)

---

# –ß—Ç–æ —Ç–∞–º, –Ω–∞ –≥–ª—É–±–∏–Ω–µ?

```c++
// v8:Factory#NewStringFromUtf8()
MaybeHandle<String> Factory::NewStringFromUtf8(
    Vector<const char> string,
    PretenureFlag pretenure
) {
  // Check for ASCII first since this is the common case.
  const char* ascii_data = string.start();
  int length = string.length();
  int non_ascii_start = String::NonAsciiStart(ascii_data, length);
  if (non_ascii_start >= length) {
    // If the string is ASCII, we do not need to convert
    // the characters since UTF8 is backwards compatible with ASCII.
    return
      NewStringFromOneByte(
        Vector<const uint8_t>::cast(string), pretenure);
  }
// ...
```

---

# –ß—Ç–æ —Ç–∞–º, –Ω–∞ –≥–ª—É–±–∏–Ω–µ?

<style scoped>
section::before {
  width: 1100px;
  height: 30px;
  background-color: rgba(235, 225, 52, 0.1);
  border: 1px solid #73736e;
  position: absolute;
  top: 382px;
  left: 90px;
}
</style>

```c++
// v8:Factory#NewStringFromUtf8()
MaybeHandle<String> Factory::NewStringFromUtf8(
    Vector<const char> string,
    PretenureFlag pretenure
) {
  // Check for ASCII first since this is the common case.
  const char* ascii_data = string.start();
  int length = string.length();
  int non_ascii_start = String::NonAsciiStart(ascii_data, length);
  if (non_ascii_start >= length) {
    // If the string is ASCII, we do not need to convert
    // the characters since UTF8 is backwards compatible with ASCII.
    return
      NewStringFromOneByte(
        Vector<const uint8_t>::cast(string), pretenure);
  }
// ...
```

---

# –ß—Ç–æ —Ç–∞–º, –Ω–∞ –≥–ª—É–±–∏–Ω–µ?

<style scoped>
section::before {
  width: 1100px;
  height: 155px;
  background-color: rgba(235, 225, 52, 0.1);
  border: 1px solid #73736e;
  position: absolute;
  top: 445px;
  left: 90px;
}
</style>

```c++
// v8:Factory#NewStringFromUtf8()
MaybeHandle<String> Factory::NewStringFromUtf8(
    Vector<const char> string,
    PretenureFlag pretenure
) {
  // Check for ASCII first since this is the common case.
  const char* ascii_data = string.start();
  int length = string.length();
  int non_ascii_start = String::NonAsciiStart(ascii_data, length);
  if (non_ascii_start >= length) {
    // If the string is ASCII, we do not need to convert
    // the characters since UTF8 is backwards compatible with ASCII.
    return
      NewStringFromOneByte(
        Vector<const uint8_t>::cast(string), pretenure);
  }
// ...
```

---

# –ò—Ç–æ–≥–∏ –º–∏–∫—Ä–æ–±–µ–Ω—á–º–∞—Ä–∫–∞

* –ì–∏–ø–æ—Ç–µ–∑–∞ –≤—ã–≥–ª—è–¥–∏—Ç –≤–µ—Å—å–º–∞ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ
* –†–µ–∞–ª–∏–∑—É–µ–º PoC –∏ –¥–µ–ª–∞–µ–º –∑–∞–º–µ—Ä

---

# PoC –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏

&nbsp; | `get()`<br/>3 B | `get()`<br/>1 KB | `get()`<br/>100 KB | `set()`<br/>3 B | `set()`<br/>1 KB | `set()`<br/>100 KB
------------:| ------------:| ------------:| ------------:| ------------:| ------------:| ------------:
v0.10.0 | 90 933 | 23 591 | 105 | 76 011 | 44 324 | 1 558
PoC | 122 458 | 104 090 | 7 052 | 110 083 | 73 618 | 8 428
&nbsp; | **+34%** | **+341%** | **+6 616%** | **+45%** | **+66%** | **+440%**

---

# –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∏—Ç–æ–≥–∏

* –ì–∏–ø–æ—Ç–µ–∑–∞ –ø—Ä–æ (–¥–µ)—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é –≤–µ—Ä–Ω–∞ –∏ –ø—Ä–∞–≤–∫–∞ –∏–¥–µ—Ç –≤ –±–ª–∏–∂–∞–π—à–∏–π —Ä–µ–ª–∏–∑
* –ü–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º, –∫–æ–Ω–µ—á–Ω–æ –∂–µ, –¥–µ–ª–∞–µ–º –µ—â–µ –æ–¥–∏–Ω –∑–∞–º–µ—Ä

---

# –ü–µ—Ä–≤—ã–π –ø—É–±–ª–∏—á–Ω—ã–π —Ä–µ–ª–∏–∑ üéâ

&nbsp; | `get()`<br/>3 B | `get()`<br/>1 KB | `get()`<br/>100 KB | `set()`<br/>3 B | `set()`<br/>1 KB | `set()`<br/>100 KB
------------:| ------------:| ------------:| ------------:| ------------:| ------------:| ------------:
v0.10.0 | 90 933 | 23 591 | 105 | 76 011 | 44 324 | 1 558
v3.12 | 132 855 | 120 670 | 8 756 | 127 291 | 94 625 | 10 617
&nbsp; | **+46%** | **+411%** | **+8 239%** | **+67%** | **+113%** | **+581%**

---

# Editor's Cut "–±—ã—Å—Ç—Ä—ã—Ö" –ø—Ä–∞–≤–æ–∫

1. –ö—É—á–∫–∞ –ª–æ–∂–Ω—ã—Ö –≥–∏–ø–æ—Ç–µ–∑ –∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ (üóëÔ∏è)
2. –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç —Å –ø—É–ª–æ–º –±—É—Ñ–µ—Ä–æ–≤ –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    - –ù–µ—É–¥–∞—á–Ω—ã–π, —Ç.–∫. –ø—Ä–∏–±–∞–≤–∫–∞ –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è
    - `Buffer#allocUnsafe()` –∏ —Ç–∞–∫ [–∏—Å–ø–æ–ª—å–∑—É–µ—Ç](https://nodejs.org/api/buffer.html#buffer_class_method_buffer_allocunsafeslow_size) –ø—É–ª (8 KB by default)
    - –†–µ–∑—É–ª—å—Ç–∞—Ç: –æ—Ç–ª–æ–∂–µ–Ω –≤ backlog
3. –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç —Å Write Queue (aka Automated Pipelining)
    - –ü—Ä–æ—Å—Ç–æ–π PoC –ø–æ–∫–∞–∑–∞–ª —É–≤–µ–ª–∏—á–µ–Ω–∏–µ write throughput –Ω–∞ 20-25%
    - –†–µ–∑—É–ª—å—Ç–∞—Ç: –æ–∫–∞–∑–∞–ª—Å—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–º –∏ –±—ã–ª –≤–∫–ª—é—á–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–µ–ª–∏–∑

---

# –°–Ω–æ–≤–∞ –∑–∞–ø—Ä—ã–≥–∏–≤–∞–µ–º –≤ üöó ‚åö

* –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫—É—á—É —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤, –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –∏ –æ–¥–∏–Ω —Ä–µ–ª–∏–∑
* –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –æ–±—Ä–∞—Ç–Ω–æ –≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ
* –ü–æ–º–Ω–∏—Ç–µ –ø—Ä–æ –ª–∏—à–Ω–∏–µ –∞–ª–ª–æ–∫–∞—Ü–∏–∏ `Buffer`?

---

# –†–∞–±–æ—Ç–∞ —Å backlog'–æ–º: –∞–ª–ª–æ–∫–∞—Ü–∏–∏ `Buffer`

* –ü–æ—Å–∫–æ–ª—å–∫—É –ø—Ä–∞–≤–∫–∏ –æ–±—ä–µ–º–Ω—ã–µ, –±—ã–ª–æ —Ä–µ—à–µ–Ω–æ –Ω–∞—á–∞—Ç—å —Å PoC
* –ü–æ–∑–≤–æ–ª–∏—Ç –æ—Ü–µ–Ω–∏—Ç—å, –æ–ø—Ä–∞–≤–¥–∞–µ—Ç –ª–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —É—Å–∏–ª–∏—è
* PoC —Ä–µ–∞–ª–∏–∑—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –¥–ª—è `Map#get()` and `Map#set()`
* –†–µ–∞–ª–∏–∑—É–µ–º –∏ –¥–µ–ª–∞–µ–º –∑–∞–º–µ—Ä...

---

# PoC –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∞–ª–ª–æ–∫–∞—Ü–∏–π

&nbsp; | `get()`<br/>3 B | `get()`<br/>1 KB | `get()`<br/>100 KB | `set()`<br/>3 B | `set()`<br/>1 KB | `set()`<br/>100 KB
------------:| ------------:| ------------:| ------------:| ------------:| ------------:| ------------:
v3.12.1 | 173 611 | 161 812 | 10 879 | 172 028 | 82 747 | 8 208
PoC | 222 172 | 192 122 | 12 594 | 205 254 | 109 051 | 11 630
&nbsp; | **+28%** | **+19%** | **+16%** | **+19%** | **+32%** | **+42%**

###### \* –ó–∞–º–µ—Ä—ã —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º Automated Pipelining

---

# –°—Ä–∞–≤–Ω–∏–º —Å —Ç–µ–º, —á—Ç–æ –±—ã–ª–æ –≤ –Ω–∞—á–∞–ª–µ

&nbsp; | `get()`<br/>3 B | `get()`<br/>1 KB | `get()`<br/>100 KB | `set()`<br/>3 B | `set()`<br/>1 KB | `set()`<br/>100 KB
------------:| ------------:| ------------:| ------------:| ------------:| ------------:| ------------:
v0.10.0 | 90 933 | 23 591 | 105 | 76 011 | 44 324 | 1 558
PoC | 222 172 | 192 122 | 12 594 | 205 254 | 109 051 | 11 630
&nbsp; | **+144%** | **+714%** | **+11&nbsp;894%** | **+170%** | **+146%** | **+646%**

###### \* –ó–∞–º–µ—Ä—ã —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º Automated Pipelining

---

# –ù–∞–∫–æ–Ω–µ—Ü-—Ç–æ!

![w:1000 center](./images/its-over-9000.jpg)

---

# –¢–µ–∫—É—â–∏–µ –ø–ª–∞–Ω—ã

1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é —Å –∞–ª–ª–æ–∫–∞—Ü–∏—è–º–∏ `Buffer`
2. –í–∫–ª—é—á–∏—Ç—å –∑–∞–º–µ—Ä—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ —Ä–µ–ª–∏–∑ —Ü–∏–∫–ª
3. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é: –≥–∏–ø–æ—Ç–µ–∑—ã, —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã, –∑–∞–º–µ—Ä—ã

---

<style scoped>
section h1 {
  position: absolute;
  top: 261px;
  left: 90px;
}
</style>

![bg](./images/hazelcast-bg-no-logo.jpg)

# –í—ã–≤–æ–¥—ã

---

# –í—ã–≤–æ–¥ #1

## –ù–µ –ø—ã—Ç–∞–π—Ç–µ—Å—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∏ —Å—Ä–∞–∑—É

* –°–Ω–∞—á–∞–ª–∞ - –≤—ã–±–æ—Ä –Ω–∞–∏–±–æ–ª–µ–µ —Ö–æ–¥–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –Ω–∞–≥—Ä—É–∑–∫–∏
* –¢–æ–ª—å–∫–æ –ø–æ—Ç–æ–º - –±–µ–Ω—á–º–∞—Ä–∫ –∏ –∞–Ω–∞–ª–∏–∑
* –ù–µ —Å—Ç–æ–∏—Ç —Å—Ä–∞–∑—É –≤–Ω–æ—Å–∏—Ç—å —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–∞–≤–∫–∏, –Ω–∞—á–∏–Ω–∞–π—Ç–µ —Å –ø–æ–∏—Å–∫–∞ "–ø—Ä–æ—Å—Ç—ã—Ö" –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
* *–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ*: –æ—á–µ–Ω—å –∑–¥–æ—Ä–æ–≤–æ, –∫–æ–≥–¥–∞ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –æ—Ç—Å–µ–∏–≤–∞—é—Ç—Å—è –µ—â–µ –Ω–∞ —ç—Ç–∞–ø–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

---

# –í—ã–≤–æ–¥ #2

## –ë–µ–Ω—á–º–∞—Ä–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∏ "—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–º–∏"

* –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
* –û–∫—Ä—É–∂–µ–Ω–∏–µ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ
* üçè vs. üçè: –ø—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ —Å—Ç–æ–∏—Ç –∏–¥—Ç–∏ –Ω–µ–±–æ–ª—å—à–∏–º–∏ —à–∞–≥–∞–º–∏, –ø–æ—ç—Ç–∞–ø–Ω–æ
* –ü—Ä–æ–≥—Ä–µ–≤ –±–µ–Ω—á–º–∞—Ä–∫–∞, –∑–∞–ø—É—Å–∫ –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ä–∞–∑ –∏ –º–∞—Ç. —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–¥–µ–ª–∞—é—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –±–æ–ª–µ–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º

---

# –í—ã–≤–æ–¥ #3

## –°–µ–º—å —Ä–∞–∑ –∑–∞–º–µ—Ä—å, –æ–¥–∏–Ω —Ä–µ–ª–∏–∑–Ω–∏

* –ù–µ —Å—Ç–æ–∏—Ç –¥–µ–ª–∞—Ç—å –ø–æ—Å–ø–µ—à–Ω—ã—Ö –≤—ã–≤–æ–¥–æ–≤ –ø–æ—Å–ª–µ –∑–∞–º–µ—Ä–∞ –≤–∞—à–µ–≥–æ –º–∏–∫—Ä–æ–±–µ–Ω—á–º–∞—Ä–∫–∞/PoC/–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
* C –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏ —Å—Ç–æ–∏—Ç —Å–æ–º–Ω–µ–≤–∞—Ç—å—Å—è –≤–æ –≤—Å–µ–º –∏ –≤—Å–µ –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—è—Ç—å

---

# –í—ã–≤–æ–¥ #4

## –í—ã–±–∏—Ä–∞–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø–æ–¥ –∑–∞–¥–∞—á—É, –∞ –Ω–µ –Ω–∞–æ–±–æ—Ä–æ—Ç

* –ù–µ —Å—Ç–æ–∏—Ç –ø—ã—Ç–∞—Ç—å—Å—è —Ä–µ—à–∏—Ç—å –ª—é–±—É—é –ø—Ä–æ–±–ª–µ–º—É —Å –ø–æ–º–æ—â—å—é, –Ω–∞–ø—Ä–∏–º–µ—Ä, flame graphs
* –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–¥–±–∏—Ä–∞–π—Ç–µ –¥—Ä—É–≥–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –≤–∞—Ä—å–∏—Ä—É–π—Ç–µ –±–µ–Ω—á–º–∞—Ä–∫–∏

---

# –í—ã–≤–æ–¥ #5

## "–ù–µ–ª—å–∑—è –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫ –≤–∑—è—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å<br/>–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ/–±–∏–±–ª–∏–æ—Ç–µ–∫—É/—Ñ—Ä–µ–π–º–≤–æ—Ä–∫" ¬© –ë–æ—Ä–æ–º–∏—Ä

* –ï—Å–ª–∏ –≤—ã —á—Ç–æ-—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–ª–∏ N –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥, —Ç–æ –æ —Ç–µ–∫—É—â–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–≤–µ—Å—Ç–Ω–æ
* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ - —ç—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å, –∞ –Ω–µ –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
* –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é:
  - –í–∫–ª—é—á–∞–π—Ç–µ –∑–∞–º–µ—Ä—ã –≤ —Ü–∏–∫–ª —Ä–µ–ª–∏–∑–æ–≤
  - –í–µ–¥–∏—Ç–µ backlog –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

---

# –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–Ω–∏–º–∞–Ω–∏–µ!

###### –í—ã–±–∏—Ä–∞–π—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ<br/>–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è/–±–∏–±–ª–∏–æ—Ç–µ–∫–∏/—Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏ –¥–ª—è –≤–∞—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ :)

![w:480 center](./images/slides-qr-code.png)

---

# –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

* https://hazelcast.org
* https://github.com/hazelcast/hazelcast-nodejs-client
* https://nodejs.org/en/docs/guides/simple-profiling
* https://nodejs.org/en/docs/guides/dont-block-the-event-loop
* https://blog.insiderattack.net/event-loop-and-the-big-picture-nodejs-event-loop-part-1-1cb67a182810
* https://www.ibm.com/developerworks/library/j-benchmark2/index.html

---

<style scoped>
section h1 {
  position: absolute;
  top: 261px;
  left: 90px;
}
</style>

![bg](./images/hazelcast-bg-no-logo.jpg)

# Bonus unlocked üèÖüèÖüèÖ

---

# –°–Ω–æ–≤–∞ –≤–∫–ª—é—á–∞–µ–º üöó ‚åö

* –û—Ç–ø—Ä–∞–≤–ª—è–µ–º—Å—è –≤–æ –≤—Ä–µ–º–µ–Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–ª–∏–∑–∞ v3.12.1
* –ò –Ω–∞—á–∏–Ω–∞–µ–º —Å –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Automated Pipelining

* –ò–¥–µ—è –≤ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –≤ —Å–æ–∫–µ—Ç
* –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –¥–µ–ª–∞–µ—Ç—Å—è –º–µ–Ω—å—à–µ "–¥–æ—Ä–æ–≥–∏—Ö" –≤—ã–∑–æ–≤–æ–≤ `Socket#write()`
* –ü–æ–¥–æ–±–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –≤ –∫–ª–∞—Å—Å–µ [WriteQueue](https://github.com/datastax/nodejs-driver/blob/master/lib/writers.js#L176) –≤ DataStax Node.js Driver for Apache Cassandra

---

# Pipelining

* –í –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö—Å—è –∫–ª–∏–µ–Ω—Ç–∞—Ö —Å—Ö–æ–∂–∏–π –ø—Ä–∏–µ–º –Ω–∞–∑—ã–≤–∞—é—Ç [pipelining](http://informatikr.com/2012/redis-pipelining.html)
* –ü—Ä–∏–º–µ—Ä pipelining API –≤ Java:

```java
Pipelining<String> pipelining = new Pipelining<>(10);
for (int i = 0; i < 100; i++) {
    pipelining.add(map.getAsync(i));
}
// –±–ª–æ–∫–∏—Ä—É–µ–º—Å—è –∏ –∂–¥–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
pipelining.results();
```

---

# Automated Pipelining

* –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ, –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–µ—è–≤–Ω—ã–º –æ–±—Ä–∞–∑–æ–º, –æ—Ç—Å—é–¥–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ - automated pipelining
* –î–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ:
  - –ë–æ–ª—å—à–µ–µ —á–∏—Å–ª–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –≤—ã–∏–≥—Ä—ã—à–µ, –ø–æ—Å–∫–æ–ª—å–∫—É –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
* –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫:
  - –ò–∑ –æ–±—ã—á–Ω–æ–≥–æ pipelining –º–æ–∂–Ω–æ "–≤—ã–∂–∞—Ç—å" –ª—É—á—à—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

---

# –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

![w:1050 center](./images/write-queue.png)

---

# –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

* –î–ª—è –±–æ–ª—å—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –∑–∞–ø–∏—Å—ã–≤–∞–µ–º—ã—Ö –≤ —Å–æ–∫–µ—Ç, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å
* –ü–æ—ç—Ç–æ–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, –≤–∫–ª—é—á–∞—é—â–∞—è "–æ–±—ã—á–Ω—ã–π" —Ä–µ–∂–∏–º
* –ü–æ—Ä–æ–≥ –∑–∞–ø–∏—Å–∏ –≤ —Å–µ—Ç—å —Ç–æ–∂–µ –≤—ã–Ω–µ—Å–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

---

# –°–Ω–æ–≤–∞ —Ä–µ–ª–∏–∑?

* Automated Pipelining –≤–æ—à–ª–∞ –≤ –±–ª–∏–∂–∞–π—à–∏–π —Ä–µ–ª–∏–∑
* –ö—Ä–æ–º–µ —ç—Ç–æ–≥–æ, —Ç—É–¥–∞ –≤–æ—à–ª–∏ –º–∏–Ω–æ—Ä–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≥–æ—Ä—è—á–µ–≥–æ –ø—É—Ç–∏:
  - –£–±—Ä–∞–ª–∏ –º—É—Å–æ—Ä –æ—Ç `new Date().getTime()` (—Å–ø–∞—Å–∏–±–æ, `Date.now()`)
  - –£–±—Ä–∞–ª–∏ –º—É—Å–æ—Ä –æ—Ç –ª–∏—à–Ω–∏—Ö –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–π `number` <-> `Long` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è [long.js](https://github.com/dcodeIO/long.js))
  - –ò–∑–±–∞–≤–∏–ª–∏—Å—å –æ—Ç –∞–ª–ª–æ–∫–∞—Ü–∏–π –±—É—Ñ–µ—Ä–æ–≤ –≤ edge cases, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –±–æ–æ–æ–ª—å—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (> 128 KB)
* –ó–∞–º–µ—Ç–Ω–æ–π –ø—Ä–∏–±–∞–≤–∫–∏ –≤ –Ω–∞—à–µ–º –±–µ–Ω—á–º–∞—Ä–∫–µ –º–∏–Ω–æ—Ä–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–µ –¥–∞–ª–∏, –Ω–æ –æ–Ω–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–ª–µ–∑–Ω—ã
* –ü–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º —Å–Ω–æ–≤–∞ –≤—Å–µ –∑–∞–º–µ—Ä—è–µ–º...

---

# –í—Ç–æ—Ä–æ–π –ø—É–±–ª–∏—á–Ω—ã–π —Ä–µ–ª–∏–∑ üéâüéâ

&nbsp; | `get()`<br/>3 B | `get()`<br/>1 KB | `get()`<br/>100 KB | `set()`<br/>3 B | `set()`<br/>1 KB | `set()`<br/>100 KB
------------:| ------------:| ------------:| ------------:| ------------:| ------------:| ------------:
v3.12 | 132 855 | 120 670 | 8 756 | 127 291 | 94 625 | 10 617
v3.12.1 | 173 611 | 161 812 | 10 879 | 172 028 | 82 747 | 8 208
&nbsp; | **+30%** | **+34%** | **+24%** | **+35%** | **-13%** | **-23%**

###### \* –ó–∞–º–µ—Ä—ã —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º Automated Pipelining
