---
marp: true
theme: default
---

<style>
img[alt~="center"] {
  display: block;
  margin: 0 auto;
}

table td {
  width: 150px;
}
</style>

# –ò—Å—Ç–æ—Ä–∏—è –æ–¥–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ Node.js –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

### –ê–Ω–¥—Ä–µ–π –ü–µ—á–∫—É—Ä–æ–≤, Hazelcast

---

<!-- paginate: true -->

# –û –¥–æ–∫–ª–∞–¥—á–∏–∫–µ

* –ü–∏—à—É –Ω–∞ Java (10+ –ª–µ—Ç), Node.js (5+ –ª–µ—Ç)
* –ò–Ω—Ç–µ—Ä–µ—Å—ã: –≤–µ–±, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
* –ú–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ —Ç—É—Ç:

  - https://twitter.com/AndreyPechkurov
  - https://github.com/puzpuzpuz
  - https://medium.com/@apechkurov

---

# –û –¥–æ–∫–ª–∞–¥–µ

* –¢–µ–º–∞: –ø–æ–¥—Ö–æ–¥ –∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ Node.js –±–∏–±–ª–∏–æ—Ç–µ–∫
* –ü–æ–¥–æ–ø—ã—Ç–Ω—ã–π: –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è Node.js –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Hazelcast IMDG
* –ê—É–¥–∏—Ç–æ—Ä–∏—è: –≤—Å–µ, –∫—Ç–æ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–µ—Ç–µ–≤—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ Node.js
* –ü–ª–∞–Ω:

  #1: –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –ø–æ–¥–æ–ø—ã—Ç–Ω—ã–º
  #2: –¶–µ–ª–∏ –∏ –æ–±—â–∏–π –ø–æ–¥—Ö–æ–¥
  #3: –ë–µ–Ω—á–º–∞—Ä–∫–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
  #4: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∑–∞–º–µ—Ä—ã, –≥–∏–ø–æ—Ç–µ–∑—ã, —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã
  #5: –ü–ª–∞–Ω—ã –Ω–∞ –±—É–¥—É—â–µ–µ

---

# #1: –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –ø–æ–¥–æ–ø—ã—Ç–Ω—ã–º

---

# Hazelcast IMDG

* https://hazelcast.org/
* Hazelcast In-Memory Data Grid (IMDG)
* –ë–æ–ª—å—à–æ–π –Ω–∞–±–æ—Ä —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö<br/> (AP –∏ CP —Å–æ–≥–ª–∞—Å–Ω–æ CAP —Ç–µ–æ—Ä–µ–º–µ)
* –ù–∞–ø–∏—Å–∞–Ω–∞ –Ω–∞ Java, —É–º–µ–µ—Ç embedded –∏ standalone —Ä–µ–∂–∏–º—ã
* –•–æ—Ä–æ—à–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
* –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ high-load –∏ low-latency –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö

---

# –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Hazelcast IMDG

![w:1100 center drop-shadow](./images/imdg-architecture-zoomed.png)

---

# Hazelcast IMDG Node.js client

* https://github.com/hazelcast/hazelcast-nodejs-client
* Node.js 4+
* –°—Ç–µ–∫: TypeScript, promisified API (bluebird)
* –ü–µ—Ä–≤—ã–π —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–µ–ª–∏–∑ - –º–∞–π 2019

---

# –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

* "–£–º–Ω–∞—è" –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
* –û–±—â–∞–µ—Ç—Å—è —Å –Ω–æ–¥–∞–º–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ –ø–æ [–æ—Ç–∫—Ä—ã—Ç–æ–º—É –±–∏–Ω–∞—Ä–Ω–æ–º—É –ø—Ä–æ—Ç–æ–∫–æ–ª—É](https://hazelcast.org/documentation/#open-binary) –ø–æ–≤–µ—Ä—Ö TCP
* –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö
* –£–º–µ–µ—Ç near cache, retry on failure, client stats –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ

---

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```javascript
const Client = require('hazelcast-client').Client;

const client = await Client.newHazelcastClient();
const cache = await client.getMap('my-awesome-cache');

await cache.set('foo', 'bar');
const cached = await cache.get('foo');
console.log(cached); // bar
```

---

# #2: –¶–µ–ª–∏ –∏ –æ–±—â–∏–π –ø–æ–¥—Ö–æ–¥

---

# –ù–∞—á–∞–ª—å–Ω—ã–µ —Ü–µ–ª–∏

* –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ —Å—Ç–∞–±–∏–ª—å–Ω—ã–º —Ä–µ–ª–∏–∑–æ–º
* –í–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ä–µ–ª–∏–∑ "–±—ã—Å—Ç—Ä—ã—Ö" –ø—Ä–∞–≤–æ–∫ (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
* –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–Ω–æ–≤ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É –∞–Ω–∞–ª–∏–∑—É –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
* *–°–ø–æ–π–ª–µ—Ä*: –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –±–æ–ª—å—à–∞—è —á–∞—Å—Ç—å –∏–∑ —ç—Ç–∏—Ö –ø–ª–∞–Ω–æ–≤ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞

---

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è?

![w:1000 center drop-shadow](./images/i-have-no-idea.jpg)

---

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è? –†–µ—Ü–µ–ø—Ç –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è

0. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (+ –∂–µ–ª–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–µ–Ω—á–º–∞—Ä–∫
2. –°–¥–µ–ª–∞—Ç—å –∑–∞–º–µ—Ä—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. –ü—Ä–æ–±–ª–µ–º–∞? –ü–æ–¥–æ–±—Ä–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
4. –ù–∞–π—Ç–∏ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞, –≤—ã–¥–≤–∏–Ω—É—Ç—å –≥–∏–ø–æ—Ç–µ–∑—ã –∏ –ø—Ä–æ–≤–µ—Å—Ç–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã
5. –°–¥–µ–ª–∞—Ç—å –∑–∞–º–µ—Ä—ã
6. `goto 0.`

---

# –í–æ–∑–º–æ–∂–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

* –°–µ—Ç–µ–≤–∞—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
* I/O bound –Ω–∞–≥—Ä—É–∑–∫–∞
* –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
  - –û–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Å–µ–∫—É–Ω–¥—É (throughput)
  - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ (—É—Å–ª–æ–≤–Ω–æ, latency)
* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
  - –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
  - –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

---

# –í—ã–±–æ—Ä –º–µ—Ç—Ä–∏–∫?

* –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º throughput
* –ñ–µ–ª–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: ¬Ø\\_(„ÉÑ)_/¬Ø

---

# –í—ã–±–æ—Ä –º–µ—Ç—Ä–∏–∫!

![w:800 center drop-shadow](./images/gotta-go-fast.jpg)

---

# #3: –ë–µ–Ω—á–º–∞—Ä–∫–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–Ω–∞–ª–∏–∑–∞

---

# –°—Ç–∞—Ä—ã–π –±–µ–Ω—á–º–∞—Ä–∫

```javascript
// ...
run: function () {
  var key = Math.random() * ENTRY_COUNT;
  var opType = Math.floor(Math.random() * 100);
  if (opType < GET_PERCENTAGE) {
      this.map.get(key).then(this.increment.bind(this));
  }
  // ...
  setImmediate(this.run.bind(this));
}
// ...
```

---

# –°—Ç–∞—Ä—ã–π –±–µ–Ω—á–º–∞—Ä–∫: –º–∏–Ω—É—Å—ã

* –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä—Ç—É—é—Ç —á–µ—Ä–µ–∑ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π `setImmediate()`
* –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ–ø–µ—Ä–∞—Ü–∏–π (concurrency limit, backpressure)
* –û–ø–µ—Ä–∞—Ü–∏–∏ –∏ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—ã–±–∏—Ä–∞—é—Ç—Å—è —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º
* –í—Å–µ —ç—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ —É—Ö—É–¥—à–∞–µ—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å

---

# –ù–æ–≤—ã–π –±–µ–Ω—á–º–∞—Ä–∫

```javascript
const benchmark = new Benchmark({
    nextOp: () => map.get('foo'),
    totalOpsCount: REQ_COUNT,
    batchSize: BATCH_SIZE
});
await benchmark.run();
```

---

# –ù–æ–≤—ã–π –±–µ–Ω—á–º–∞—Ä–∫: –ø–ª—é—Å—ã

* –û–ø–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä—Ç—É—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
* –û–±—â–µ–µ —á–∏—Å–ª–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å—Ç–∞—Ä—Ç–æ–≤–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ
* –û–ø–µ—Ä–∞—Ü–∏–∏ –∏ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã

---

# –ù–æ–≤—ã–π –±–µ–Ω—á–º–∞—Ä–∫: –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è

–ü—Ä–∏–º–µ—Ä —Å `batchSize = 3` –∏ `totalOpsCount = 7`:
```text
op1--->|op6--->| finish
op2->|op4------>| finish
op3->|op5-->|op7->| finish
```

–ü—Ä–æ—Å—Ç–æ–π `Promise.all()`:
```text
op1--->|op4--->   |       finish
op2->  |op5------>|       finish
op3->  |op6-->    |op7->| finish
```

---

# –°—Ü–µ–Ω–∞—Ä–∏–π –±–µ–Ω—á–º–∞—Ä–∫–∞

* –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ-–±–µ–Ω—á–º–∞—Ä–∫ —Å –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π
* –ö–ª–∞—Å—Ç–µ—Ä –∏–∑ –æ–¥–Ω–æ–π –Ω–æ–¥—ã IMDG (Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)
* –õ–æ–∫–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞ (loopback address)
* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ Linux, Node.js, IMDG –∏ —Ç.–¥.
* –û–ø–µ—Ä–∞—Ü–∏–∏: `IMap.get()` –∏ `IMap.set()`
* –î–∞–Ω–Ω—ã–µ: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å ASCII-—Å–∏–º–≤–æ–ª–∞–º–∏ (3 B, 1 KB, 100 KB)
* –ó–∞–º–µ—Ä: –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—É—Å–∫–æ–≤ –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
* –ö–∞–∂–¥—ã–π –∑–∞–ø—É—Å–∫: 1 –º–ª–Ω –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ª–∏–º–∏—Ç–æ–º 100

---

# –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç #1

* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫ Node.js
* –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ V8 sample-based profiler
* –£—á–∏—Ç—ã–≤–∞–µ—Ç JS –∏ C++ –∫–æ–¥
* `node --prof app.js`
* –ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ:
`node --prof-process isolate-0xnnnnnnnnnnnn-v8.log > processed.txt`

---

# –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞

```
 [Summary]:
   ticks  total  nonlib   name
   4144   77.3%   78.0%  JavaScript
   1157   21.6%   21.8%  C++
    374    7.0%    7.0%  GC
     51    1.0%          Shared libraries
     11    0.2%          Unaccounted

 [JavaScript]:
   ticks  total  nonlib   name
   2104   39.2%   39.6%  Builtin: StringAdd_CheckNone_NotTenured
   1312   24.5%   24.7%  LazyCompile: *<anonymous> :1:20
    484    9.0%    9.1%  LazyCompile: *suite.add ./app.js:68:7
    ...
      8    0.1%    0.2%  LazyCompile: ~<anonymous> ./util.js:51:44
 ...
```

---

# –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç #2

* –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è –≤ –≤–∏–¥–µ flame graph
* –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ–º–æ–≥–∞–µ—Ç –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—Ç—å –±–æ—Ç–ª–Ω–µ–∫–∏
* –û—Ç–ª–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è event loop'–∞ Node.js
* –°–ø–∞—Å–∏–±–æ Brendan Gregg, Netflix, [–ø—Ä–∏–¥—É–º–∞–≤—à–µ–º—É –ø–æ–¥—Ö–æ–¥](https://www.usenix.org/conference/lisa13/technical-sessions/plenary/gregg) –≤ 2013
* –ù–∞–∏–±–æ–ª–µ–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç - [0x](https://github.com/davidmarkclements/0x) (V8, perf, DTrace)
* –ú—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ [flamebearer](https://github.com/mapbox/flamebearer) (V8)

```bash
$ npm install -g flamebearer
$ node --prof-process --preprocess -j isolate*.log | flamebearer
```

---

# –ü—Ä–∏–º–µ—Ä –ø—Ä–æ—Å—Ç–µ–π—à–µ–≥–æ flame graph

![w:980 center](./images/flame-graph-example.png)

---

# –ü—Ä–∏–º–µ—Ä flame graph –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–∏—Ä–∞

![w:980 center](./images/flame-graph-complex-example.png)

---

# –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç #3

* –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫ –ø–∞–º—è—Ç–∏ –∏–∑ Chrome DevTools (Node.js)
* –£–º–µ–µ—Ç –¥–µ–ª–∞—Ç—å heap snapshot, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∞–ª–ª–æ–∫–∞—Ü–∏–∏ –∏ –Ω–µ —Ç–æ–ª—å–∫–æ

![w:720 center drop-shadow](./images/chrome-devtools-example.png)

---

# –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç #4

* –ú–∏–∫—Ä–æ–±–µ–Ω—á–º–∞—Ä–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–∏–ø–æ—Ç–µ–∑
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ [Benchmark.js](https://benchmarkjs.com/) (+ node-microtime)
* *–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ*: –º–æ–≥—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –≤ –ê–Ω—Ç–∞—Ä–∫—Ç–∏–¥–µ

---

# –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç #5

* Proof of concept (PoC)
* –í—Å–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ —Ö–æ—Ä–æ—à–∏, –Ω–æ –Ω—É–∂–µ–Ω –≤–µ—Å—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∫–æ–¥–∞ –Ω–∞ –≥–æ—Ä—è—á–µ–º –ø—É—Ç–∏
* *–ü.–°.*: —ç—Ç–æ –Ω–µ —Å–æ–≤—Å–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –Ω–æ –Ω–µ —É–ø–æ–º—è–Ω—É—Ç—å –Ω–µ–ª—å–∑—è

---

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ–∫–ª–∏—Å—Ç

```
[X] –ú–µ—Ç—Ä–∏–∫–∏
[X] –ë–µ–Ω—á–º–∞—Ä–∫
[X] –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–Ω–∞–ª–∏–∑–∞
[ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
```

---

# #4: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∑–∞–º–µ—Ä—ã, –≥–∏–ø–æ—Ç–µ–∑—ã, —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã

---

# –ì–æ—Ä—è—á–∏–π –ø—É—Ç—å

1. –°—Ç–∞—Ä—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ `Promise`)
2. –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
3. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Å–µ—Ç—å –≤ `socket.write(...)`
5. –ß—Ç–µ–Ω–∏–µ —Ñ—Ä–µ–π–º–∞ –≤ `socket.on('data', ...)`
6. –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
7. –í—ã–∑–æ–≤ `resolve()` —É `Promise`'–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏

---

# –ë–∞–∑–æ–≤—ã–π –∑–∞–º–µ—Ä

&nbsp; | 3 B | 1 KB | 100 KB
------------:|------------:| ------------:| ------------:
`Map#get()` | 90 933 | 23 591 | 105
`Map#set()` | 76 011 | 44 324 | 1 558

---

# –í–∏–¥–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã?

* Java-–∫–ª–∏–µ–Ω—Ç –¥–ª—è `get('foo', 'bar')` –±—ã—Å—Ç—Ä–µ–µ –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ 5 —Ä–∞–∑
(—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∑–∞–≤–µ–¥–æ–º–æ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ)
* –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ª–∏–Ω–µ–π–Ω–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

---

# –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫, –ø—Ä–∏–¥–∏! (–∑–∞–ø–∏—Å—å 3 B)

![w:1080 center](./images/old-set-3B-flamegraph.png)

---

# –•—å—é—Å—Ç–æ–Ω, —É –Ω–∞—Å –∞–ª–ª–æ–∫–∞—Ü–∏–∏

* –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∏–Ω–∞—Ä–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏, –∫–æ–Ω–µ—á–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è [Buffer](https://nodejs.org/api/buffer.html)
* –í –Ω–∞ –≥–æ—Ä—è—á–µ–º –ø—É—Ç–∏ –º–Ω–æ–≥–æ `Buffer#alloc()/#allocUnsafe()`, –∞ —ç—Ç–æ "–¥–æ—Ä–æ–≥–∞—è" –æ–ø–µ—Ä–∞—Ü–∏—è
* –í–æ –≤—Ä–µ–º—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–ª–ª–æ–∫–∞—Ü–∏–π, –∞ –∑–∞—Ç–µ–º –±—É—Ñ–µ—Ä—ã –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –≤ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π
* –≠—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –∫–æ–¥, –Ω–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞–¥–∞–µ—Ç
* –°–Ω–∞—á–∞–ª–∞ –¥–µ–ª–∞–µ–º PoC —Å –ø–æ–ª—É–º–µ—Ä–æ–π, –ø–æ—Å–∫–æ–ª—å–∫—É –ø–æ–ª–Ω–∞—è –ø—Ä–∞–≤–∫–∞ —Ç—Ä–µ–±—É–µ—Ç –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏

---

# PoC —Å –ø–æ–ª—É–º–µ—Ä–æ–π

```javascript
export class ObjectDataOutput implements DataOutput {

    protected buffer: Buffer;
    private pos: number;

    constructor() {
        // –ø—Ä–æ–±—É–µ–º –∞–ª–ª–æ—Ü–∏—Ä–æ–≤–∞—Ç—å –∂–∞–¥–Ω–æ
-       this.buffer = Buffer.allocUnsafe(1);
+       this.buffer = Buffer.allocUnsafe(1024);

        // ...
```

---

# –ó–∞–º–µ—Ä –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ PoC

&nbsp; | `get()`<br/>3 B | `get()`<br/>1 KB | `get()`<br/>100 KB | `set()`<br/>3 B | `set()`<br/>1 KB | `set()`<br/>100 KB
------------:| ------------:| ------------:| ------------:| ------------:| ------------:| ------------:
v0.10.0 | 90 933 | 23 591 | 105 | 76 011 | 44 324 | 1 558
PoC | 104 854 | 24 929 | 109 | 95 165 | 52 809 | 1 581
&nbsp; | **+15%** | **+5%** | **+3%** | **+25%** | **+19%** | **+1%**

---

# –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∏—Ç–æ–≥–∏

* –ì–∏–ø–æ—Ç–µ–∑–∞ –≤–µ—Ä–Ω–∞ –∏ –ø—Ä–∞–≤–∫–∞ –∏–¥–µ—Ç –≤ –±–ª–∏–∂–∞–π—à–∏–π —Ä–µ–ª–∏–∑
* –ù—É–∂–Ω–æ –∏–∑–±–∞–≤–∏—Ç—å—Å—è –æ—Ç –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ª–∏—à–Ω–∏—Ö –∞–ª–ª–æ–∫–∞—Ü–∏–π –≤ –±—É–¥—É—â–∏—Ö —Ä–µ–ª–∏–∑–∞—Ö
* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –æ—Å—Ç–∞–≤–ª—è—é—Ç –∂–µ–ª–∞—Ç—å –ª—É—á—à–µ–≥–æ
* –¢–∞–∫ —á—Ç–æ –∂–µ —É –Ω–∞—Å —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å—é –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö?

---

# –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫, –ø—Ä–∏–¥–∏! (—á—Ç–µ–Ω–∏—è 100 KB)

<!-- TODO –æ–±—ä—è—Å–Ω–∏—Ç—å –±–æ–ª—å—à–æ–µ –ø–ª–∞—Ç–æ —Å BaseProxy.js -->

![w:1080 center](./images/old-get-100KB-flamegraph.png)

---

# –ê —á—Ç–æ —ç—Ç–æ —É –Ω–∞—Å —Ç–∞–º?

```javascript
private readUTF(pos?: number): string {
    const len = this.readInt(pos);
    // ...
    for (let i = 0; i < len; i++) {
        let charCode: number;
        leadingByte = this.readByte(readingIndex) & MASK_1BYTE;
        readingIndex = this.addOrUndefined(readingIndex, 1);
        const b = leadingByte & 0xFF;
        switch (b >> 4) {
            // ...
        }
        result += String.fromCharCode(charCode);
    }
    return result;
}
```

---

# –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è?

* –ò—Ç–∞–∫, —É –Ω–∞—Å –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è (–¥–µ)—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è UTF-8 —Å—Ç—Ä–æ–∫
* –ü–æ—Ö–æ–∂–µ –Ω–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é
* –ü–æ—á–µ–º—É –±—ã –Ω–µ —Å—Ä–∞–≤–Ω–∏—Ç—å —Å–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º API?

```javascript
// —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
buf.write(inStr, start, end, 'utf8');
// –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
const outStr = buf.toString('utf8', start, end);
```

---

# –ú–∏–∫—Ä–æ–±–µ–Ω—á–º–∞—Ä–∫

&nbsp; | 100 B ASCII | 100 KB ASCII | 100 B UTF | 100 KB UTF
------------:| ------------:| ------------:| ------------:| ------------:
custom | 1 515 803 | 616 | 1 093 390 | 613
standard | 11 297 821 | 68 721 | 1 311 610 | 794
&nbsp; | **+645%** | **+11 056%** | **+20%** | **+29%**

\* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ ops/sec

---

# –ü—Ä–æ–≤–∞–ª–∏–≤–∞–µ–º—Å—è –≤ –∫—Ä–æ–ª–∏—á—å—é –Ω–æ—Ä—É

* [Buffer#toString()](https://github.com/nodejs/node/blob/v10.15.3/lib/buffer.js#L667)
* [node:buffer.js#stringSlice()](https://github.com/nodejs/node/blob/v10.15.3/lib/buffer.js#L594)
* [node:node_buffer.cc#StringSlice()](https://github.com/nodejs/node/blob/v10.15.3/src/node_buffer.cc#L452)
* [node:StringBytes#Encode()](https://github.com/nodejs/node/blob/v10.15.3/src/string_bytes.cc#L665)
* [v8:String#NewFromUtf8()](https://github.com/v8/v8/blob/lkgr/6.8/src/api.cc#L6622)
* [v8:Factory#NewStringFromUtf8()](https://github.com/v8/v8/blob/lkgr/6.8/src/heap/factory.cc#L609)
* [v8:Factory#NewStringFromOneByte()](https://github.com/v8/v8/blob/lkgr/6.8/src/heap/factory.cc#L583)

---

# –ß—Ç–æ —Ç–∞–º, –≤ –Ω–æ—Ä–µ?

```c++
// v8:Factory#NewStringFromUtf8()
MaybeHandle<String> Factory::NewStringFromUtf8(
    Vector<const char> string,
    PretenureFlag pretenure
) {
  // Check for ASCII first since this is the common case.
  const char* ascii_data = string.start();
  int length = string.length();
  int non_ascii_start = String::NonAsciiStart(ascii_data, length);
  if (non_ascii_start >= length) {
    // If the string is ASCII, we do not need to convert
    // the characters since UTF8 is backwards compatible with ASCII.
    return
      NewStringFromOneByte(
        Vector<const uint8_t>::cast(string), pretenure);
  }
// ...
```

---

# PoC –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏

&nbsp; | `get()`<br/>3 B | `get()`<br/>1 KB | `get()`<br/>100 KB | `set()`<br/>3 B | `set()`<br/>1 KB | `set()`<br/>100 KB
------------:| ------------:| ------------:| ------------:| ------------:| ------------:| ------------:
v0.10.0 | 90 933 | 23 591 | 105 | 76 011 | 44 324 | 1 558
PoC | 122 458 | 104 090 | 7 052 | 110 083 | 73 618 | 8 428
&nbsp; | **+34%** | **+341%** | **+6 616%** | **+45%** | **+66%** | **+440%**

---

# –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∏—Ç–æ–≥–∏

* –ì–∏–ø–æ—Ç–µ–∑–∞ –≤–µ—Ä–Ω–∞ –∏ –ø—Ä–∞–≤–∫–∞ –∏–¥–µ—Ç –≤ –±–ª–∏–∂–∞–π—à–∏–π —Ä–µ–ª–∏–∑

---

# –ü–µ—Ä–≤—ã–π –ø—É–±–ª–∏—á–Ω—ã–π —Ä–µ–ª–∏–∑ üéâ

&nbsp; | `get()`<br/>3 B | `get()`<br/>1 KB | `get()`<br/>100 KB | `set()`<br/>3 B | `set()`<br/>1 KB | `set()`<br/>100 KB
------------:| ------------:| ------------:| ------------:| ------------:| ------------:| ------------:
v0.10.0 | 90 933 | 23 591 | 105 | 76 011 | 44 324 | 1 558
v3.12 | 132 855 | 120 670 | 8 756 | 127 291 | 94 625 | 10 617
&nbsp; | **+46%** | **+411%** | **+8 239%** | **+67%** | **+113%** | **+581%**

---

# Editor's Cut

* –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç —Å –ø—É–ª–æ–º –±—É—Ñ–µ—Ä–æ–≤ –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  - –ù–µ—É–¥–∞—á–Ω—ã–π. –ö —Ç–æ–º—É –∂–µ, `Buffer#allocUnsafe()` –∏ —Ç–∞–∫ [–∏—Å–ø–æ–ª—å–∑—É–µ—Ç](https://nodejs.org/api/buffer.html#buffer_class_method_buffer_allocunsafeslow_size) –ø—É–ª (8 KB by default)
* –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç —Å Write Queue (aka Automated Pipelining)
  - –û–∫–∞–∑–∞–ª—Å—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–º –∏ –±—ã–ª –æ—Ç–ª–æ–∂–µ–Ω –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–µ–ª–∏–∑–∞. –ü—Ä–æ—Å—Ç–æ–π PoC –ø–æ–∫–∞–∑–∞–ª —É–≤–µ–ª–∏—á–µ–Ω–∏–µ write throughput –Ω–∞ 20-25%

---

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Automated Pipelining

* –ü–æ–¥–æ–±–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –≤ [–∫–ª–∞—Å—Å–µ WriteQueue](https://github.com/datastax/nodejs-driver/blob/master/lib/writers.js#L176) –≤ Datastax's NodeJS driver for Apache Cassandra
* –ò–¥–µ—è –≤ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –≤ —Å–æ–∫–µ—Ç
* –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ, –¥–µ–ª–∞–µ—Ç—Å—è –º–µ–Ω—å—à–µ "–¥–æ—Ä–æ–≥–∏—Ö" –≤—ã–∑–æ–≤–æ–≤ `Socket#write()`
* –í –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö—Å—è –∫–ª–∏–µ–Ω—Ç–∞—Ö —Å—Ö–æ–∂–∏–π –ø—Ä–∏–µ–º –Ω–∞–∑—ã–≤–∞—é—Ç [pipelining](http://informatikr.com/2012/redis-pipelining.html)
* –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ, –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–µ—è–≤–Ω—ã–º –æ–±—Ä–∞–∑–æ–º, –æ—Ç—Å—é–¥–∞ automated pipelining

---

# –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã Automated Pipelining

![w:1080 center](./images/write-queue.png)

---

# –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –î–ª—è –±–æ–ª—å—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —ç—Ç–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–æ–∂–µ—Ç —É—Ö—É–¥—à–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
* –ü–æ—ç—Ç–æ–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, –≤–∫–ª—é—á–∞—é—â–∞—è "–æ–±—ã—á–Ω—ã–π" —Ä–µ–∂–∏–º
* –ü–æ—Ä–æ–≥ –∑–∞–ø–∏—Å–∏ –≤ —Å–µ—Ç—å —Ç–æ–∂–µ –≤—ã–Ω–µ—Å–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

---

# –°–Ω–æ–≤–∞ —Ä–µ–ª–∏–∑?

* Automated Pipelining –ø–æ—à–ª–∞ –≤ –±–ª–∏–∂–∞–π—à–∏–π —Ä–µ–ª–∏–∑
* –ö—Ä–æ–º–µ —ç—Ç–æ–≥–æ, —Ç—É–¥–∞ –≤–æ—à–ª–∏ –º–∏–Ω–æ—Ä–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≥–æ—Ä—è—á–µ–≥–æ –ø—É—Ç–∏:
  - –£–±—Ä–∞–ª–∏ –º—É—Å–æ—Ä –æ—Ç `new Date().getTime()` (—Å–ø–∞—Å–∏–±–æ, `Date.now()`)
  - –£–±—Ä–∞–ª–∏ –º—É—Å–æ—Ä –æ—Ç –ª–∏—à–Ω–∏—Ö –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–π `number` <-> `Long` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è [long.js](https://github.com/dcodeIO/long.js))
  - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–ª–∏ –∞–ª–ª–æ–∫–∞—Ü–∏–∏ –±—É—Ñ–µ—Ä–æ–≤ –≤ edge cases, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –±–æ–æ–æ–ª—å—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (> 128 KB)
* *–°–ø–æ–π–ª–µ—Ä*: –∑–∞–º–µ—Ç–Ω–æ–π –ø—Ä–∏–±–∞–≤–∫–∏ –º–∏–Ω–æ—Ä–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–µ –¥–∞–ª–∏, –Ω–æ –æ–Ω–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–ª–µ–∑–Ω—ã

---

# –í—Ç–æ—Ä–æ–π –ø—É–±–ª–∏—á–Ω—ã–π —Ä–µ–ª–∏–∑

&nbsp; | `get()`<br/>3 B | `get()`<br/>1 KB | `get()`<br/>100 KB | `set()`<br/>3 B | `set()`<br/>1 KB | `set()`<br/>100 KB
------------:| ------------:| ------------:| ------------:| ------------:| ------------:| ------------:
v3.12 | 132 855 | 120 670 | 8 756 | 127 291 | 94 625 | 10 617
v3.12.1 | 173 611 | 161 812 | 10 879 | 172 028 | 82 747 | 8 208
&nbsp; | **+30%** | **+34%** | **+24%** | **+35%** | **-13%** | **-23%**

\* –ó–∞–º–µ—Ä—ã —Å –≤–∫–ª—é—á–µ–Ω–Ω–æ–π Automated Pipelining

---

# –ê –∫–∞–∫ –∂–µ –∞–ª–ª–æ–∫–∞—Ü–∏–∏?

* –ü–æ—Å–∫–æ–ª—å–∫—É –ø—Ä–∞–≤–∫–∏ –æ–±—ä–µ–º–Ω—ã–µ, –±—ã–ª–æ —Ä–µ—à–µ–Ω–æ –Ω–∞—á–∞—Ç—å —Å PoC
* PoC —Ä–µ–∞–ª–∏–∑—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –¥–ª—è `IMap.get()` and `IMap.set()`
* –û–Ω –ø–æ–∑–≤–æ–ª–∏—Ç –æ—Ü–µ–Ω–∏—Ç—å, –æ–ø—Ä–∞–≤–¥–∞–µ—Ç –ª–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —É—Å–∏–ª–∏—è

---

# PoC –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∞–ª–ª–æ–∫–∞—Ü–∏–π

&nbsp; | `get()`<br/>3 B | `get()`<br/>1 KB | `get()`<br/>100 KB | `set()`<br/>3 B | `set()`<br/>1 KB | `set()`<br/>100 KB
------------:| ------------:| ------------:| ------------:| ------------:| ------------:| ------------:
v3.12.1 | 173 611 | 161 812 | 10 879 | 172 028 | 82 747 | 8 208
PoC | 222 172 | 192 122 | 12 594 | 205 254 | 109 051 | 11 630
&nbsp; | **+28%** | **+19%** | **+16%** | **+19%** | **+32%** | **+42%**

\* –ó–∞–º–µ—Ä—ã —Å –≤–∫–ª—é—á–µ–Ω–Ω–æ–π Automated Pipelining

---

# –°—Ä–∞–≤–Ω–∏–º —Å —Ç–µ–º, —á—Ç–æ –±—ã–ª–æ –≤ –Ω–∞—á–∞–ª–µ

&nbsp; | `get()`<br/>3 B | `get()`<br/>1 KB | `get()`<br/>100 KB | `set()`<br/>3 B | `set()`<br/>1 KB | `set()`<br/>100 KB
------------:| ------------:| ------------:| ------------:| ------------:| ------------:| ------------:
v0.10.0 | 90 933 | 23 591 | 105 | 76 011 | 44 324 | 1 558
PoC | 222 172 | 192 122 | 12 594 | 205 254 | 109 051 | 11 630
&nbsp; | **+144%** | **+714%** | **+11&nbsp;894%** | **+170%** | **+146%** | **+646%**

\* –ó–∞–º–µ—Ä—ã —Å –≤–∫–ª—é—á–µ–Ω–Ω–æ–π Automated Pipelining

---

# –ù–∞–∫–æ–Ω–µ—Ü-—Ç–æ!

![w:1000 center drop-shadow](./images/its-over-9000.jpg)

---

# #5: –ü–ª–∞–Ω—ã –Ω–∞ –±—É–¥—É—â–µ–µ

1. –ò–∑–±–∞–≤–∏—Ç—å—Å—è –æ—Ç –ª–∏—à–Ω–∏—Ö –∞–ª–ª–æ–∫–∞—Ü–∏–π –±—É—Ñ–µ—Ä–æ–≤
2. –í–∫–ª—é—á–∏—Ç—å –∑–∞–º–µ—Ä—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ —Ä–µ–ª–∏–∑ —Ü–∏–∫–ª
3. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é

---

# –ù–µ–º–Ω–æ–≥–æ —Å–æ–≤–µ—Ç–æ–≤

<!-- TODO –ø–æ–¥—É–º–∞—Ç—å –ø—Ä–æ –¥–æ–ø. —Å–æ–≤–µ—Ç—ã -->

* –ù–µ –ø—ã—Ç–∞–π—Ç–µ—Å—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∏ —Å—Ä–∞–∑—É
* –°—Ç–∞—Ä–∞–π—Ç–µ—Å—å —É–º–µ–Ω—å—à–∏—Ç—å —á–∏—Å–ª–æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∏ –¥–≤–∏–∂—É—â–∏—Ö—Å—è —á–∞—Å—Ç–µ–π
* –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≥–∏–ø–æ—Ç–µ–∑—ã –ø—Ä–∏ –ø–æ–º–æ—â–∏ PoC –∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –º–∏–∫—Ä–æ–±–µ–Ω—á–º–∞—Ä–∫–æ–≤
* –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ, —á—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ - —ç—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å

---

# –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

* https://hazelcast.org/
* https://github.com/hazelcast/hazelcast-nodejs-client
* https://nodejs.org/en/docs/guides/simple-profiling/
* https://nodejs.org/en/docs/guides/dont-block-the-event-loop/
* https://blog.insiderattack.net/event-loop-and-the-big-picture-nodejs-event-loop-part-1-1cb67a182810

---

# –°–ª–∞–π–¥—ã

![w:600 center](./images/slides-qr-code.png)

---

# –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–Ω–∏–º–∞–Ω–∏–µ!

## –í—Ä–µ–º—è –¥–ª—è Q&A
